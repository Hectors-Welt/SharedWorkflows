name: Build and deploy

on:
  workflow_call:
    secrets:
      hangfireFeedUrl:
        required: true  
      hangfireUsername:
        required: true
      hangfirePassword:
        required: true
      nexusAptRepoUsername:
        required: true
      nexusAptRepoPassword:
        required: true
      nexusAptRepoHost:
        required: true 
      nexusAptRepoPrereleaseHost:
        required: true  
      nexusDockerUsername: 
        required: true
      nexusDockerPassword:
        required: true
      nugetGithubHost:
        required: true
      nugetGithubUsername:
        required: true
      nugetGithubPassword:
        required: true
      packageRepoHost: 
        required: true
      packageRepoPassword:
        required: true
      packageRepoUsername:
        required: true
      packageRepoPort:
        required: true
      dockerRepo:
        required: true        


jobs:
  check:
     runs-on: ubuntu-latest
     outputs:
        runtime: ${{ steps.check_file.outputs.result }}
        matrix: ${{steps.check_file.outputs.JSON }}
     steps:
      - name: Check if file was created
        id: check_file
        run: |
          JSON=$(cat ./package.json)
          echo "::set-output name=matrix::${JSON//'%'/'%25'}"

          if [[ -d src ]]; then
              echo "result=node" >> $GITHUB_OUTPUT
              echo node
          else
              echo "result=dotnet" >> $GITHUB_OUTPUT
              echo dotnet
          fi      
      - name: List files in the repository
        run: |
          echo ${{steps.check_file.outputs.matrix }}
          ls ${{ github.workspace }}
  dotnet:
      needs: check
      if: ${{ needs.check.outputs.runtime == 'dotnet' }} 
      uses: Hectors-Welt/SharedWorkflows/.github/workflows/build_and_deploy_dotnet.yml@main
      secrets:
        nexusAptRepoUsername: ${{ secrets.nexusAptRepoUsername }}
        nexusAptRepoPassword: ${{ secrets.nexusAptRepoPassword }}
        nexusAptRepoPrereleaseHost: ${{ secrets.nexusAptRepoPrereleaseHost }}
        nexusAptRepoHost: ${{ secrets.nexusAptRepoHost}}
        hangfireFeedUrl: ${{ secrets.hangfireFeedUrl }}
        hangfireUsername: ${{ secrets.hangfireUsername }}
        hangfirePassword: ${{ secrets.hangfirePassword }}
        nugetGithubHost: ${{ secrets.nugetGithubHost }}
        nugetGithubUsername: ${{ secrets.nugetGithubUsernam }}
        nugetGithubPassword: ${{ secrets.nugetGithubPassword }}
        packageRepoHost: ${{ secrets.packageRepoHost }}
        packageRepoPassword: ${{ secrets.packageRepoPassword }}
        packageRepoUsername: ${{ secrets.packageRepoUsername }}
        packageRepoPort: ${{ secrets.packageRepoPort }}
        dockerRepo: ${{ secrets.dockerRepo }}
        nexusDockerUsername: ${{ secrets.nexusDockerUsername }}
        nexusDockerPassword: ${{ secrets.nexusDockerPassword }}

  node:
      needs: check
      if: ${{ needs.check.outputs.runtime == 'node' }} 
      uses: Hectors-Welt/SharedWorkflows/.github/workflows/build_and_deploy_node.yml@main
      secrets:
        nexusAptRepoUsername: ${{ secrets.nexusAptRepoUsername }}
        nexusAptRepoPassword: ${{ secrets.nexusAptRepoPassword }}
        nexusAptRepoPrereleaseHost: ${{ secrets.nexusAptRepoPrereleaseHost }}
        nexusAptRepoHost: ${{ secrets.nexusAptRepoHost}}
        hangfireFeedUrl: ${{ secrets.hangfireFeedUrl }}
        hangfireUsername: ${{ secrets.hangfireUsername }}
        hangfirePassword: ${{ secrets.hangfirePassword }}
        nugetGithubHost: ${{ secrets.nugetGithubHost }}
        nugetGithubUsername: ${{ secrets.nugetGithubUsernam }}
        nugetGithubPassword: ${{ secrets.nugetGithubPassword }}
        packageRepoHost: ${{ secrets.packageRepoHost }}
        packageRepoPassword: ${{ secrets.packageRepoPassword }}
        packageRepoUsername: ${{ secrets.packageRepoUsername }}
        packageRepoPort: ${{ secrets.packageRepoPort }}
        dockerRepo: ${{ secrets.dockerRepo }}
        nexusDockerUsername: ${{ secrets.nexusDockerUsername }}
        nexusDockerPassword: ${{ secrets.nexusDockerPassword }}
        

